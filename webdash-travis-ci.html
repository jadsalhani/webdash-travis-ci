<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/empty-state-webdash/empty-state-webdash.html">

<dom-module id="webdash-travis-ci">
  <template>
    <style>
      :host {
        display: block;
      }

      /*
      * Some of the available colors
      * var(--brand), var(--accent), var(--danger), var(--success), var(--alternative)
      * var(--gray-9), var(--gray-8), var(--gray-7), ... var(--gray-3)
      * 
      * these colors can be accessed from JavaScript (if needed)
      * this.accent = getComputedStyle(this).getPropertyValue('--accent');
      * https://codetogo.io/how-to-get-css-custom-property-in-javascript/
      */
    </style>

    <template is="dom-if" if="{{emptyState}}">
      <empty-state-webdash title="Missing configuration">
        <template is="dom-repeat" items="{{errorMessages}}">
          <div inner-h-t-m-l="{{item}}"></div>
        </template>
      </empty-state-webdash>
    </template>

    <template is="dom-if" if="{{firstRepoBuildStatus}}">
      Last build status: {{ firstRepoBuildStatus }}
    </template>

    <div>
      <template is="dom-repeat" items="{{currentActiveBuilds}}" rendered-item-count="{{renderedCount}}">
        Commit message: {{ item.commit.message }}
      </template>

      <template is="dom-if" if="{{!renderedCount}}">
        No current running builds!
      </template>
    </div>

    <div>
      <template is="dom-if" if="{{!emptyState}}">
        <div>
          Result of last 2 builds:
        </div>
      </template>
      <template is="dom-repeat" items="{{lastBuilds}}">
        <div class="">
          Commit message: {{ item.commit.message }}
          <br> State: {{ item.state }}
        </div>
      </template>
    </div>

  </template>

  <script>
    class WebdashTravisCi extends Polymer.Element {
      static get is() {
        return 'webdash-travis-ci';
      }

      ready() {
        super.ready();
        this.backend = new Backend(WebdashTravisCi.is);
        this.run();
      }

      run() {
        this.backend.get("check-config").then(response => {
          if (response.errors) {
            this.emptyState = true;
            this.errorMessages = response.errorMessages;
            return false;
          }
          this.getLastRepoState();
          this.getActiveBuilds();
          this.getLastBuilds();
        });
      }

      getLastRepoState() {
        this.backend.get('build-status').then(data => {
          this.firstRepoBuildStatus = data.builds[0].state;
        })
      }

      getLastBuilds() {
        this.backend.get('last-builds').then(data => {
          this.lastBuilds = data.builds;
        });
      }

      getActiveBuilds() {
        this.backend.get('active-builds').then(data => {
          this.currentActiveBuilds = data.builds;
        });
      }
    }

    window.customElements.define(WebdashTravisCi.is, WebdashTravisCi);
  </script>
</dom-module>